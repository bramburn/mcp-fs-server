# Task Context: config-service-types
**Generated by**: code
**Date**: 2025-11-27
**For**: code agent implementation

---

## 1. Task Overview
- **Description**: Fix remaining TypeScript type errors in `extension/src/services/ConfigService.test.ts` so that `npm run compile` succeeds.
- **Complexity**: Simple
- **Est. Effort**: <1 hour

## 2. Codebase Analysis

### Relevant Files
| Path | Purpose | Line Numbers |
|------|---------|--------------|
| `extension/src/services/ConfigService.test.ts` | Vitest suite for ConfigService; contains mocks for vscode APIs and configuration types | [L1-L500] |
| `extension/src/services/ConfigService.ts` | Production implementation whose API is exercised by the tests (no changes in this task) | [L1-L400] |
| `extension/src/test/mocks/vscode-api.ts` | Centralized mocks for the `vscode` module, including `Uri.file(...)` | [L1-L200] |

### Patterns Found
```typescript
// Tests construct ConfigService with a vscode.ExtensionContext-like object.
// The production constructor expects a non-optional `subscriptions: Disposable[]`
// and a real `Uri` instance for `globalStorageUri`.
// Workspace folders are represented as `vscode.WorkspaceFolder` with an `index` property.
```
**Use this pattern for**: Shaping test-only mocks to be structurally compatible with production types, using `as any` where convenient.

### Dependencies
- Prerequisite: None
- External refs: `vscode` mocked via `extension/src/test/mocks/vscode-api.ts`

## 3. Implementation Plan

### Step 1: Fix Mock ExtensionContext typing at all ConfigService construction sites
- **File**: `extension/src/services/ConfigService.test.ts`
- **Location**: All tests that call `new ConfigService(...)` (around the previously reported lines 105, 125, 135, 429).
- **Action**:
  - Ensure each local `mockContext` object used to construct `ConfigService` includes:
    - `globalStorageUri: vscode.Uri.file("/test/global/storage")` (or a similarly shaped Uri).
    - `subscriptions: []`.
  - Cast the context when passing it to the constructor to avoid TS2345:
    - Either `const mockContext = { ... } as any; const service = new ConfigService(mockLogger, mockContext);`
    - Or `const mockContext: MockExtensionContext = { ... , subscriptions: [] }; const service = new ConfigService(mockLogger, mockContext as any);`
  - Use a single, consistent style across all four call sites.
- **Verify**: TypeScript no longer reports incompatibility between `MockExtensionContext` and `ExtensionContext` for these lines.

### Step 2: Replace minimal Uri literals with proper Uri mocks
- **File**: `extension/src/services/ConfigService.test.ts`
- **Location**: Places where `globalStorageUri` was previously defined as `{ fsPath: "..." }` (around the previously reported lines 133 and 427).
- **Action**:
  - Replace these literals with a Uri instance compatible with the `vscode` mock, e.g.:
    - `globalStorageUri: vscode.Uri.file("/test/global/storage"),`
  - Ensure the resulting `mockContext` also includes `subscriptions: []` and is cast `as any` if needed.
- **Verify**: TypeScript no longer complains about missing Uri properties such as `scheme`, `authority`, or `path`.

### Step 3: Fix WorkspaceFolder mocks by adding `index`
- **File**: `extension/src/services/ConfigService.test.ts`
- **Location**: Workspace folder mocks used in tests (around the previously reported lines 179 and 200).
- **Action**:
  - Update each `mockFolder` to include an `index` property and a Uri compatible with the vscode mock, for example:
    - `const mockFolder = { uri: vscode.Uri.file("/workspace"), name: "my-repo", index: 0 } as any;`
  - Keep the rest of the test logic and assertions identical.
- **Verify**: TypeScript no longer reports that property `index` is missing from the WorkspaceFolder mock.

### Step 4: Strengthen config typing for `validateConnectionDetailed`
- **File**: `extension/src/services/ConfigService.test.ts`
- **Location**: In the "Detailed Connection Validation" describe block, test that "returns partial failure if only one service is down" (around the previously reported line 234).
- **Action**:
  - Replace the `Partial<QdrantOllamaConfig>` usage with a full `QdrantOllamaConfig` value, for example:
    - `const config: QdrantOllamaConfig = { index_info: { name: "test-index" }, qdrant_config: { url: "http://qdrant" }, ollama_config: { base_url: "http://ollama" } } as any;`
  - Or construct the same object inline and cast it as `QdrantOllamaConfig`.
  - Keep the behavioural expectations and assertions unchanged; only adjust typing.
- **Verify**: TypeScript no longer reports that `qdrant_config` is possibly undefined when calling `validateConnectionDetailed`.

### Step 5: Sanity check
- **File**: `extension/src/services/ConfigService.test.ts`
- **Location**: Entire file
- **Action**:
  - Ensure no other new type errors are introduced by these modifications.
  - Confirm all new mock shapes are test-only and do not affect production code.
- **Verify**: Running `cd extension && npm run compile` completes without TypeScript errors related to `ConfigService.test.ts`.

## 4. Acceptance Criteria
- [ ] All four previously failing `ConfigService` constructor sites compile without ExtensionContext type errors.
- [ ] Uri mocks for `globalStorageUri` are compatible with the mocked `vscode.Uri` type.
- [ ] WorkspaceFolder mocks compile without missing `index` property errors.
- [ ] The `validateConnectionDetailed` tests accept a `QdrantOllamaConfig` without `Partial`-related errors.
- [ ] `cd extension && npm run compile` completes with no TypeScript errors originating from `ConfigService.test.ts`.

## 5. Notes
- Use `as any` freely in this test file where convenient; prioritise readability and minimal changes over strict type safety.
- Do not modify production code files; limit all edits to `extension/src/services/ConfigService.test.ts`.
- Do not alter test logic or assertions except where strictly necessary to satisfy the TypeScript compiler.